services:
  # GATEWAY
  gateway:
    build: ./Gateway
    ports:
      - "4000:4000"
    depends_on:
      - email-service
      - inventory-service-app
      - user-service-app
      - order-service-app
      - event-service-app
      - reservation-service-app
    networks:
      - backend-network

  email-service:
    build: ./ms7-email-service
    ports:
      - "4007:4007"
    environment:
      - PORT=4007
    networks:
      - backend-network

  # MICROSERVICIO 1 - INVENTARIO
  inventory-service-app: 
    build: ./ms1-inventory-service/SistemaDeInventario
    depends_on:
      - inventory-mysql
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - DB_HOST=inventory-mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD:-MiContraseñaSegura123!}
      - DB_NAME=don_papa
      - NODE_ENV=development
      - JWT_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - JWT_REFRESH_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
    networks:
      - backend-network

  inventory-mysql:  
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME_INVENTORY}  
    volumes:
      - inventory_mysql_data:/var/lib/mysql
    networks:
      - backend-network

  # MICROSERVICIO 2 - USUARIOS
  user-service-app:
    build: ./ms2-user-service/UsuariosYEmpleados
    depends_on:
      user-mysql:
        condition: service_healthy
    ports:
      - "4002:4002"
    environment:
      - SERVER_PORT=4002
      - PORT=4002
      - DB_HOST=user-mysql
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=${DB_PASSWORD:-MiContraseñaSegura123!}
      - DB_NAME=don_papa
      - SPRING_PROFILES_ACTIVE=development
      - JPA_SHOW_SQL=true
      - HIBERNATE_DIALECT=org.hibernate.dialect.MySQL8Dialect
      - JWT_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - JWT_REFRESH_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
    networks:
      - backend-network

  user-mysql:  
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME_USERS}
    volumes:
      - users_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    networks:
      - backend-network

  # MICROSERVICIO 3 - PEDIDOS
  order-service-app:
    build: ./ms3-order-service/Pedidos
    depends_on:
      - order-mysql
      - inventory-service-app
      - user-service-app
      - reservation-service-app
      - event-service-app
      - email-service
    ports:
      - "4003:4003"
    environment:
      - PORT=4003
      - NODE_ENV=development
      - DB_HOST=order-mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD:-MiContraseñaSegura123!}
      - DB_NAME=don_papa
      - JWT_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - JWT_REFRESH_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - EMAIL_SERVICE_URL=http://email-service:4007
      - INVENTORY_SERVICE_URL=http://inventory-service-app:4001/api
      - USER_SERVICE_URL=http://user-service-app:4002/api/clientes
      - RESERVATION_SERVICE_URL=http://reservation-service-app:4004/api
      - EVENT_SERVICE_URL=http://event-service-app:4005/api
      - RECEIPTS_DIR=recibos
    volumes:
      - order_receipts:/app/recibos
    networks:
      - backend-network

  order-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-MiContraseñaSegura123!}
      MYSQL_DATABASE: don_papa
    volumes:
      - order_mysql_data:/var/lib/mysql
    networks:
      - backend-network



  # MICROSERVICIO 4 - RESERVAS Y MESAS
  reservation-service-app:
    build: ./ms4-reservation-service/ReservasYMesas
    depends_on:
      - reservation-mysql
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
      - DB_HOST=reservation-mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD:-MiContraseñaSegura123!}
      - DB_NAME=don_papa
      - NODE_ENV=development
      - JWT_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - USER_SERVICE_URL=http://user-service-app:4002/api/clientes
    networks:
      - backend-network

  reservation-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME_RESERVATIONS}
    volumes:
      - reservation_mysql_data:/var/lib/mysql
    networks:
      - backend-network


  # MICROSERVICIO 5 - EVENTOS
  event-service-app:  
    build: ./ms5-event-service/EventosYPromociones
    depends_on:
      - event-mysql
    ports:
      - "4005:4005"
    environment:
      - PORT=4005
      - DB_HOST=event-mysql
      - NODE_ENV=development
      
    networks:
      - backend-network

  event-mysql: 
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME_EVENTS}  
    volumes:
      - events_mysql_data:/var/lib/mysql
    networks:
      - backend-network

  # MICROSERVICIO 6 - REPORTES
  report-service-app:
    build: ./ms6-report-service/ReportesYVitacora
    depends_on:
      - report-mysql
      - order-service-app
    ports: 
      - "4006:4006"
    environment:
      - PORT=4006
      - NODE_ENV=development
      - DB_HOST=report-mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD:-MiContraseñaSegura123!}
      - DB_NAME=don_papa
      - JWT_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - JWT_REFRESH_SECRET=tu_super_secreto_jwt_development_very_secure_key_12345
      - ORDER_SERVICE_URL=http://order-service-app:4003
      - HTTP_TIMEOUT=10000
      - ALLOWED_ORIGINS=http://localhost:3000,http://localhost:4000
    networks:
      - backend-network

  report-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-MiContraseñaSegura123!}
      MYSQL_DATABASE: don_papa
    volumes:
      - report_mysql_data:/var/lib/mysql
    networks:
      - backend-network
  

volumes:
  inventory_mysql_data:
  users_mysql_data: 
  order_mysql_data:
  events_mysql_data:
  reservation_mysql_data:
  report_mysql_data:
  order_receipts:

networks:
  backend-network:
    driver: bridge